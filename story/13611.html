<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何使用Linux lsof命令</title><link rel="stylesheet" href="/css.css"></head><body><div id="header"><a class="site_title" href="http://www.fuzadu.com">复杂度</a></div><div><div><h2>如何使用Linux lsof命令</h2></div><div class="content"><p>如果Linux中的所有东西都是一个文件，那么它一定不仅仅是硬盘上的文件。本教程将向您展示如何使用lsof查看作为文件处理的所有其他设备和进程。</p><p>在Linux上，一切都是一个文件</p><p>经常被引用的一句话，Linux中的一切都是一个文件，这在某种程度上是正确的。文件是字节的集合。当它们被读入程序或发送到打印机时，它们似乎会生成字节流。当它们被写入时，它们接受字节流。</p><p>许多其他系统组件接受或生成字节流，例如键盘、套接字连接、打印机和通信进程。因为它们接受、生成或接受并生成字节流，所以可以在非常低的级别上处理这些设备，就像它们是文件一样。</p><p>这种设计理念简化了Unix操作系统的实现。这意味着可以创建一小组处理程序、工具和API来处理各种不同的资源。</p><p>驻留在硬盘上的数据和程序文件是普通的旧文件系统文件。我们可以使用ls命令列出它们并查找有关它们的一些详细信息。</p><p>我们如何了解所有其他被视为文件的进程和设备？我们使用lsof命令。这将列出系统中打开的文件。也就是说，它列出了正在处理的所有内容，就好像它是一个文件一样。</p><p>相关：在Linux中“一切都是文件”是什么意思？</p><p>lsof命令</p><p>lsof可以报告的许多进程或设备属于root或由root启动，因此您需要将sudo命令与lsof一起使用。</p><p>因为这个列表将非常长，我们将通过较少的管道将其传递出去。</p><code>sudo lsof | less</code><img class="content_img" src="/image/fc/fcf896cd36cf29cc1f104db8d19325b6.png" /><p>在lsof输出出现之前，GNOME用户可能会在终端窗口中看到一条警告消息。</p><code>lsof: WARNING: can't stat() fuse.gvfsd-fuse file system /run/user/1000/gvfs
Output information may be incomplete.</code><p>lsof尝试处理所有挂载的文件系统。引发此警告消息是因为lsof遇到了GNOME虚拟文件系统(GVFS)。这是用户空间(FUSE)中文件系统的特例。它充当GNOME、其API和内核之间的桥梁。除了挂载文件系统的所有者(在本例中是GNOME)之外，没有人(甚至根用户)可以访问这些文件系统中的任何一个。您可以忽略此警告。</p><p>lsof的输出非常广泛。最左边的列是：</p><img class="content_img" src="/image/50/504c9b34299cc61a2b8605d8efc9a3bd.png" /><p>最右侧的列是：</p><img class="content_img" src="/image/08/088ca78dbd2c9d129c5af033db5130f6.png" /><p>lsof列</p><p>并非所有列都适用于每种类型的打开文件。它们中的一些是空白的，这是正常的。</p><p>
命令：输入与打开文件的进程相关联的命令名称。
PID：打开文件的进程的进程标识号。
TID：任务(线程)标识号。空栏表示它不是任务；它是进程。
User：进程所属用户的用户ID或名称，或者/proc中拥有目录的人员的用户ID或登录名，lsof在/proc中查找有关进程的信息。
fd：显示文件的文件描述符。文件描述符如下所述。
类型：文件关联的节点类型，备注类型如下。
Device：包含特殊字符、块特殊、常规、目录或NFS文件的设备编号(用逗号分隔)，或包含标识该文件的内核引用地址。它还可能显示Linux AX.25套接字设备的基本地址或设备名称。
Size/Off：显示文件的大小或文件偏移量(以字节为单位)。
节点：显示本地文件的索引节点号，或服务器主机中NFS文件的索引节点号，或互联网协议类型。它可能会显示流的STR，或者Linux AX.25套接字设备的IRQ或inode编号。
名称：显示文件所在的挂载点和文件系统的名称。</p><p>FD列</p><p>fd列中的文件描述符可以是众多选项之一；手册页将列出所有选项。</p><p>FD列条目可以由三部分组成：文件描述符、模式字符和锁定字符。一些常见的文件描述符包括：</p><p>
CWD：当前工作目录。
错误：FD信息错误(参见名称栏)。
ltx：共享库文本(代码和数据)。
M86：DOS合并映射文件。
MEM：内存映射文件。
mmap：内存映射设备。
pd：父目录。
RTD：根目录。
txt：程序文本(代码和数据)。
一个数字，表示文件描述符。</p><p>模式字符可以是以下字符之一：</p><p>
R：读取访问权限。
W：写访问权限。
U：读写访问权限。
‘’：如果模式未知且没有锁定字符，则为空格字符。
-：模式未知，并且存在锁定字符。</p><p>锁定字符可以是以下之一：</p><p>
R：文件部分上的读取锁定。
R：对整个文件的读锁定。
W：对文件的一部分进行写锁定。
W：对整个文件进行写锁定。
U：任意长度的读写锁。
U：未知的锁类型。
‘’：空格字符。没有锁。</p><p>TYPE列</p><p>TYPE列中可能会出现70多个条目。您将看到的一些常见条目包括：</p><p>
REG：常规文件系统文件。
dir：目录。
先进先出：先进先出。
CHR：字符专用文件。
BLK：阻止特殊文件。
iNet：互联网插座。
UNIX：UNIX域套接字</p><p>请参阅已打开文件的进程</p><p>要查看已打开某个文件的进程，请将该文件的名称作为参数提供给lsof。例如，要查看已打开kern.log文件的进程，请使用以下命令：</p><code>sudo lsof /var/log/kern.log</code><img class="content_img" src="/image/fb/fb670f481b4a53943cb6a08b79edbbdd.png" /><p>lsof通过显示由用户syslog启动的单个进程rsyslogd进行响应。</p><img class="content_img" src="/image/86/86772e304a61c96537c596bc4b241688.png" /><p>查看从目录打开的所有文件</p><p>要查看已从目录打开的文件以及打开它们的进程，请将该目录作为参数传递给lsof。您必须使用+D(目录)选项。</p><p>要查看/var/log/目录中打开的所有文件，请使用以下命令：</p><code>sudo lsof +D /var/log/</code><img class="content_img" src="/image/38/383579bf535a2fcd77e605c23924d0d0.png" /><p>lsof使用该目录中所有打开的文件的列表进行响应。</p><img class="content_img" src="/image/df/df01adb07d2a8adb061b409e35b1951b.png" /><p>要查看已从/home目录打开的所有文件，请使用以下命令：</p><code>sudo lsof +D /home</code><img class="content_img" src="/image/f9/f991760ad2aa1b3b0edf7bc9dc3226cd.png" /><p>将显示已从/home目录打开的文件。请注意，某些列中的描述越短，整个清单就越窄。</p><img class="content_img" src="/image/7a/7ad82e185c561d8c07f763887284d5a9.png" /><p>列出进程打开的文件</p><p>要查看特定进程打开的文件，请使用-c(命令)选项。请注意，您可以一次向lsof提供多个搜索词。</p><code>sudo lsof -c ssh -c init</code><img class="content_img" src="/image/17/1728d3243e078aaea41b699b718668b4.png" /><p>lsof提供已由命令行上提供的任一进程打开的文件列表。</p><img class="content_img" src="/image/6e/6e5b35608c209e5dccd06a4510c7e265.png" /><p>请参见由用户打开的文件</p><p>要将显示限制为特定用户已打开的文件，请使用-u(用户)选项。在本例中，我们将查看由代表Mary拥有或启动的进程打开的文件。</p><code>sudo lsof -u mary</code><img class="content_img" src="/image/3a/3aba356e46a56505d8f4184cff6fe02c.png" /><p>列出的所有文件都已代表用户Mary打开。这包括例如由桌面环境打开的文件，或者仅仅是因为Mary登录而打开的文件。</p><img class="content_img" src="/image/33/33089ddb66176b5c859d0d75aa3612ba.png" /><p>排除用户打开的文件</p><p>要排除用户已打开的文件，请使用^2运算符。将用户从列表中排除可以更容易地找到您感兴趣的信息。您必须像以前一样使用-u选项，并在用户名的开头添加^字符。</p><code>sudo lsof +D /home -u ^mary</code><img class="content_img" src="/image/24/24a66bd7b4ba69c4596c88cf2474be75.png" /><p>这一次，/home目录的清单不包括用户Mary打开的任何文件。</p><img class="content_img" src="/image/95/950ce2554ec8b891975e0b777b235dd8.png" /><p>列出进程打开的文件</p><p>要列出特定进程打开的文件，请使用-p(进程)选项并提供进程ID作为参数。</p><code>sudo lsof - p 4610</code><img class="content_img" src="/image/2b/2be75c46b88d7c3337bca54b6a7e0078.png" /><p>系统会为您列出已由您提供的进程ID打开的所有文件。</p><img class="content_img" src="/image/16/16789a5d19a5ce3a9db5d312627b9430.png" /><p>列出已打开文件的进程ID</p><p>要查看已打开特定文件的进程的进程ID，请使用-t(简明)选项并在命令行中提供该文件的名称。</p><code>sudo lsof -t /usr/share/mime/mime.cache</code><img class="content_img" src="/image/c9/c9b206c6223ce900b086eb42b51006c0.png" /><p>进程ID显示在一个简单的列表中。</p><img class="content_img" src="/image/f4/f48b0a76bc3185fcc244ee971abfb82f.png" /><p>使用AND和OR搜索</p><p>让我们列出用户Mary已经打开的与SSH进程相关的文件。我们知道我们可以在命令行上提供多个搜索项，所以这应该很容易。</p><code>sudo lsof -u mary -c ssh</code><img class="content_img" src="/image/7a/7a1dc28b8647a1536af1ec1be380bbb5.png" /><p>现在让我们看一下lsof的输出。这看起来不太对；输出中有一些条目是由root启动的。</p><img class="content_img" src="/image/33/335418961382e3a40683af48d7355a8b.png" /><p>这不是我们预想的。发生了什么？</p><p>当您提供多个搜索词时，lsof将返回与第一个搜索词或第二个搜索词匹配的任何文件，依此类推。换句话说，它执行OR搜索。</p><p>要使lsof执行AND搜索，请使用-a(AND)选项。这意味着将只列出与第一个搜索词和第二个搜索词匹配的文件，依此类推。</p><p>让我们再试一次，然后使用-a选项。</p><code>sudo lsof -u mary -c ssh -a</code><img class="content_img" src="/image/87/87fee035c9cea033bd2ef619952958cb.png" /><p>现在，清单中的每个文件都是由Mary打开或代表Mary打开的文件，并且与SSH命令相关联。</p><img class="content_img" src="/image/fd/fd11cfbf2210a255b64f1079ec063e7c.png" /><p>自动刷新显示器</p><p>我们可以使用+|-r(重复)选项将lsof置于重复模式。Repeat选项有两种应用方式，+r或-r。我们还必须添加刷新显示前希望lsof等待的秒数。</p><p>使用任一格式的REPEAT选项都会使lsof照常显示结果，但它会在显示的底部添加一条虚线。它等待命令行上提供的秒数，然后用一组新的结果刷新显示。</p><p>使用-r选项时，此操作将持续到您按Ctrl+C。使用+r格式时，此操作将继续，直到没有要显示的结果或您按Ctrl+C。</p><code>sudo lsof -u mary -c ssh -a -r5</code><img class="content_img" src="/image/3f/3fc7b5b4c07dbd72f5ec200f3ae095bc.png" /><p>请注意清单底部的虚线。这将在刷新输出时分隔每个新的数据显示。</p><img class="content_img" src="/image/4f/4f0afb6fe88bda073d6ff3142a0644b0.png" /><p>显示与Internet连接关联的文件</p><p>-i选项(Internet)允许您查看由与网络和Internet连接相关联的进程打开的文件。</p><code>lsof -i</code><img class="content_img" src="/image/24/24911e7b1082f30ce34c534db94d29f3.png" /><p>将显示通过网络和Internet连接打开的所有文件。</p><img class="content_img" src="/image/2e/2eae9750b366859e6e176c718595d311.png" /><p>按进程ID显示与Internet连接关联的文件</p><p>要查看通过与特定进程ID关联的Internet连接打开的文件，请添加-p选项和-a选项。</p><p>在这里，我们正在查找通过Internet或网络连接、ID为606的进程打开的文件。</p><code>sudo lsof -i -a -p 606</code><img class="content_img" src="/image/93/93ed5f54c02c987c04248b83138c6ce1.png" /><p>将显示由进程ID 606打开的与互联网或网络连接相关联的所有文件。</p><img class="content_img" src="/image/e6/e6f097e1eb6d7f1695deb71df595cc9c.png" /><p>显示与Internet连接和命令关联的文件</p><p>我们可以使用-c(命令)选项查找由特定进程打开的文件。要查找已通过与.ssh进程关联的Internet或网络连接打开的文件，请使用以下命令：</p><code>lsof -i -a -c ssh</code><img class="content_img" src="/image/d3/d31f949b1ca910a857bd21e7d9c1736f.png" /><p>输出中列出了由于ssh进程而打开的所有文件。</p><img class="content_img" src="/image/c7/c70650fff129cb26e1de000df002d631.png" /><p>显示与Internet连接和端口关联的文件</p><p>我们可以对特定端口上通过互联网或网络连接打开的文件进行lsof报告。为此，我们使用：字符后跟端口号。</p><p>在这里，我们要求lsof列出已通过使用端口22的网络或Internet连接打开的文件。</p><code>lsof -i :22</code><img class="content_img" src="/image/d4/d4f56fdc233ce00eb65ddaf7014cf865.png" /><p>所有列出的文件都是由与端口22(SSH连接的默认端口)关联的进程打开的。</p><img class="content_img" src="/image/52/520b24ee41451bc79b52af6296cb98be.png" /><p>显示与Internet连接和协议关联的文件</p><p>我们可以要求lsof显示已由与使用特定协议的网络和Internet连接相关联的进程打开的文件。我们可以从TCP、UDP和SMTP中选择。让我们使用TCP协议，看看我们能得到什么。</p><code>sudo lsof -i tcp</code><img class="content_img" src="/image/10/1092a32d6c69091d95cc832b06acf5bc.png" /><p>列出的唯一文件是那些由使用TCP协议的进程打开的文件。</p><img class="content_img" src="/image/80/80b5935a25e2c980291829fcd836d9c8.png" /><p>我们只触及了皮毛</p><p>在Llsof的一些常见用例中，这是一个很好的基础，但还有更多的原因。根据手册页超过2800行的长度可以判断还能增加多少。</p><p>lsof命令可用于深入打开文件和伪文件的层次。我们提供了一张草图，地图册在手册页。</p><div class="item_info"><span class="item_key"><a href="/tag/文件/">文件</a></span><span class="item_key"><a href="/tag/lsof/">lsof</a></span><span class="item_key"><a href="/tag/进程/">进程</a></span></div></div><div class="relate_story"><div><h3>相关文章</h3></div><ul><li><a href="/story/14796.html">如何在Linux上使用JOIN命令</a><li><a href="/story/14712.html">如何使用Google Drive Progative Web App</a><li><a href="/story/14624.html">解释的Linux文件时间戳：atime、mtime和ctime</a><li><a href="/story/14550.html">如何在Linux上使用Tail命令</a><li><a href="/story/14514.html">您想知道的关于Linux上的inode的所有信息</a><li><a href="/story/14471.html">如何在Google Drive中更改文件所有者</a><li><a href="/story/14454.html">如何在Linux上使用stat命令</a><li><a href="/story/14419.html">如何在Linux中获取文件或目录的大小</a><li><a href="/story/14347.html">如何使用cURL从Linux命令行下载文件</a><li><a href="/story/14315.html">免费下载：Microsoft批量重命名PowerToy</a><li><a href="/story/14306.html">如何创建USB驱动器的映像</a><li><a href="/story/14240.html">如何在Linux上使用LESS命令</a><li><a href="/story/14209.html">如何在Google Drive中分配任务</a><li><a href="/story/14188.html">如何最终确定和撤销对共享Google文件的访问</a><li><a href="/story/14167.html">如何共享指向您的Google文件的“复制”链接</a><li><a href="/story/14164.html">如何将Google文档、工作表或幻灯片文件共享为网页</a><li><a href="/story/14127.html">如何在iPhone和iPad上将文件复制和备份到外部存储</a><li><a href="/story/14088.html">如何在iPhone或iPad上使用Safari下载文件</a><li><a href="/story/14037.html">如何在Linux上创建别名和Shell函数</a><li><a href="/story/14026.html">如何在Linux上使用chgrp命令</a></ul></div></div><div id="footer">&copy 2020 fuzadu.com</div></body></html>