<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何在Linux上使用超时命令</title><link rel="stylesheet" href="/css.css"></head><body><div id="header"><a class="site_title" href="http://www.fuzadu.com">复杂度</a></div><div><div><h2>如何在Linux上使用超时命令</h2></div><div class="content"><p>好的，这就是足够的电脑时间了。您可以给进程设置时间限制，用timeout命令设置它们可以运行的最长时间。以下是使用此命令对运行程序进行限制的教程。</p><p>超时对你有什么作用？</p><p>设置超时命令允许您对程序将运行的时间长度设置限制。但你为什么要这么做呢？</p><p>一种情况是，您确切地知道希望进程运行多长时间。一种常见的用例是让超时来控制日志记录或数据捕获程序，这样日志文件就不会无情地吞噬您的硬盘空间。</p><p>另一种情况是，您不知道希望进程运行多长时间，但您知道不希望它无限期运行。您可能习惯于设置进程运行，最小化终端窗口，然后忘记它们。</p><p>某些程序-即使是简单的实用程序-可能会生成可能会影响网络性能的网络流量。或者，它们可以占用目标设备上的资源，从而降低其性能。(平，我正看着你呢。)。当您离开计算机时，让这些类型的程序长时间运行是不好的做法。</p><p>超时是GNU核心实用程序的一部分，因此Linux和类似Unix的操作系统(如MacOS)都内置了超时。没有什么需要安装的，您可以开箱即用。</p><p>超时入门</p><p>这里有一个简单的例子。例如，使用其默认的命令行选项，ping命令将一直运行，直到您按Ctrl+C将其停止。如果您不中断它，它将继续运行。</p><code>ping 192.168.4.28</code><img class="content_img" src="/image/7b/7b37ab85729069b4b0e554ef1e2cc648.png" /><p>通过使用超时，我们可以确保ping不会一直运行，不会占用网络带宽，也不会纠缠正在ping的任何设备。</p><p>下一个命令使用超时命令来限制ping的时间。我们允许15秒的运行时间来执行ping。</p><code>timeout 15 ping 192.168.4.28</code><img class="content_img" src="/image/7e/7e5c75b90b03e700a9f0e49c0c4d63a1.png" /><p>15秒后，超时将终止ping会话，我们将返回到命令行提示符。</p><img class="content_img" src="/image/43/43e3aa343067cc61299302ce1bf05555.png" /><p>将超时与其他时间单位一起使用</p><p>请注意，我们不必在15后面添加“s”。超时假设该值以秒为单位。你可以加一个“s”，但这真的没什么不同。</p><p>要使用以分钟、小时或天为单位的时间值，请添加“m”、“h”或“d”。</p><p>要让ping运行三分钟，请使用以下命令：</p><code>timeout 3m ping 192.168.4.28</code><img class="content_img" src="/image/7d/7d9d222d89322459008f8e3fdff85873.png" /><p>ping将运行三分钟，然后超时并介入并暂停ping会话。</p><img class="content_img" src="/image/e6/e6e57cd37b1b642692f4e16c52a796ca.png" /><p>使用超时限制数据捕获</p><p>某些数据捕获文件可能会很快变大。要防止此类文件变得笨重甚至在大小上有问题，请限制允许运行捕获程序的时间量。</p><p>在本例中，我们使用tcpdump，这是一个网络流量捕获工具。在本文研究的测试机器上，tcpdump已经安装在Ubuntu Linux和Fedora Linux上。它必须使用以下命令安装在Manjaro Linux和Arch Linux上：</p><code>sudo pacman -Syu tcpdump</code><img class="content_img" src="/image/b2/b2ab68ef9e53ae32e57598ad016d1eda.png" /><p>我们可以使用其默认选项运行tcpdump 10秒，并使用以下命令将其输出重定向到名为capture.txt的文件：</p><code>timeout 10 sudo tcpdump > capture.txt</code><img class="content_img" src="/image/18/180f5eaa95d834e5c1ea495d9155135b.png" /><p>(tcpdump有自己的选项将捕获的网络流量保存到文件。这是一个快速攻击，因为我们讨论的是超时，而不是tcpdump。)</p><p>tcpdump开始捕获网络流量，我们等待10秒钟。10秒过去了，tcpdump仍在运行，capture.txt的大小仍在增长。需要匆忙按下Ctrl+C才能停止tcpdump。</p><p>使用ls检查capture.txt的大小，发现它在几秒钟内增长到209K。那个文件增长很快！</p><code>ls -lh capture.txt</code><img class="content_img" src="/image/bc/bcf333d69b455fd6c668546644971efc.png" /><p>发生了什么？为什么超时没有阻止tcpdump？</p><p>这都和信号有关。</p><p>发出正确的信号</p><p>当超时想要停止程序时，它发送SIGTERM信号。这会礼貌地请求程序终止。某些程序可能选择忽略SIGTERM信号。当这种情况发生时，我们需要告诉超时更有力一点。</p><p>我们可以通过要求超时来发送SIGKILL信号来实现这一点。</p><p>SIGKILL信号不能被“捕获、阻止或忽略”--它总是能通过。SIGKILL不会礼貌地要求程序停止。SIGKILL拿着秒表和COSH躲在角落里。</p><p>我们可以使用-s(信号)选项告知超时以发送SIGKILL信号。</p><code>timeout -s SIGKILL 10 sudo tcpdump > capture.txt</code><img class="content_img" src="/image/fa/fad956b8da684451f4fd5e1f337a6fb9.png" /><p>这一次，一旦经过10秒，tcpdump就会停止。</p><img class="content_img" src="/image/2a/2abddaf730ab776ad76c9e9915e0f467.png" /><p>先礼貌地问</p><p>我们可以要求超时以尝试使用SIGTERM停止程序，如果SIGTERM不起作用，则仅发送SIGKILL。</p><p>为此，我们使用-k(删除之后)选项。k选项需要时间值作为参数。</p><p>在此命令中，我们要求超时以让dmesg运行30秒，然后使用SIGTERM信号终止它。如果dmesg在40秒后仍在运行，这意味着外交SIGTERM被忽略，超时应该发送SIGKILL来完成作业。</p><p>dmesg是一个实用程序，可以监视内核环缓冲区消息并在终端窗口中显示它们。</p><code>timeout -k 40 30 dmseg -w</code><img class="content_img" src="/image/0c/0cf771245f61454e23ed42f634a3e229.png" /><p>dmesg运行30秒，并在收到SIGTERM信号时停止。</p><img class="content_img" src="/image/54/542dbbbc0693095124a79db150075838.png" /><p>我们知道不是SIGKILL阻止了dmesg，因为SIGKILL总是在终端窗口留下一个字的讣告：“杀死”。在这种情况下没有发生这种情况。</p><p>正在检索程序的退出代码</p><p>行为良好的程序在终止时将一个值传回shell。这称为退出代码。通常，这用于告诉shell(或启动程序的任何进程)程序在运行时是否遇到问题。</p><p>超时提供了自己的退出代码，但我们可能并不关心这一点。我们可能对超时控制的进程的退出代码更感兴趣。</p><p>此命令可让ping运行五秒钟。它正在ping一台名为Nostromo的计算机，该计算机位于用于研究本文的测试网络上。</p><code>timeout 5 ping Nostromo.local</code><img class="content_img" src="/image/ce/ce4ac90135a4cecc0d74e8ed46c4ec44.png" /><p>该命令运行5秒，超时将终止该命令。然后，我们可以使用以下命令检查退出代码：</p><code>echo $?</code><img class="content_img" src="/image/29/296c7be2d9c61d7541cc341f6ca89b4d.png" /><p>退票码是124。这是TIMEOUT用来指示程序已使用SIGTERM终止的值。如果SIGKILL终止程序，则退出代码为137。</p><p>如果我们使用Ctrl+C来中断程序，则超时的退出代码为零。</p><code>timeout 5 ping Nostromo.local</code><code>echo $?</code><img class="content_img" src="/image/b1/b12758fc14c5815e8a649d2ab4a3eec0.png" /><p>如果程序的执行在超时终止之前结束，超时可以将退出代码从程序传递回shell。</p><p>要做到这一点，程序必须自动停止(换句话说，它不会因超时而终止)，并且我们必须使用--preserve-status选项。</p><p>如果我们使用值为5的-c(Count)选项，ping将只发出5个请求。如果我们将超时时间定为一分钟，ping肯定会自行终止。然后，我们可以使用ECHO检查退出值。</p><code>timeout --preserve-status 1m ping -c 5 Nostromo.local</code><code>echo $?</code><img class="content_img" src="/image/e0/e0cfb72a5467cc45bda20d9fba6310bf.png" /><p>Ping完成其五个ping请求并终止。退出代码是零。</p><p>要验证退出代码是否来自ping，让我们强制执行ping以生成不同的退出代码。如果我们尝试向不存在的IP地址发送ping请求，ping将失败，并显示错误退出代码。然后，我们可以使用ECHO检查退出代码是否是非零。</p><code>timeout --preserve-status 1m ping -c 5 NotHere.local</code><code>echo $?</code><img class="content_img" src="/image/05/052bed580dd3a5e7e6791123c7762a72.png" /><p>ping命令显然无法到达不存在的设备，因此它报告错误并关闭。退出代码是2。这是ping用于一般错误的退出代码。</p><p>设置基本规则</p><p>超时就是为正在运行的程序提供一些界限。如果存在日志文件可能溢出您的硬盘的危险，或者您可能会忘记您的网络工具正在运行，请在超时时将它们包装起来，让您的计算机自我调节。</p><div class="item_info"><span class="item_key"><a href="/tag/程序/">程序</a></span><span class="item_key"><a href="/tag/运行/">运行</a></span><span class="item_key"><a href="/tag/ping/">ping</a></span></div></div><div class="relate_story"><div><h3>相关文章</h3></div><ul><li><a href="/story/14448.html">如何在Linux上使用Which命令</a><li><a href="/story/11954.html">如何在Windows 10中卸载或修复程序</a><li><a href="/story/11115.html">Windows中的ProgramData文件夹是什么？</a><li><a href="/story/11103.html">什么是ASLR，它如何保护您的计算机安全？</a><li><a href="/story/10510.html">如何在Mac上启用和配置屏幕保护程序</a><li><a href="/story/10139.html">如何添加指示器以查看您在Windows 10中使用的虚拟桌面</a><li><a href="/story/9690.html">Windows 10可能会在未询问的情况下删除您的程序</a><li><a href="/story/9190.html">帕普斯解释道：什么是“可能有害的程序”？</a><li><a href="/story/8536.html">如何让您的Windows 10 PC启动更快</a><li><a href="/story/8128.html">如何使用WinPatrol监视Windows PC的更改</a><li><a href="/story/7988.html">通过命令提示符运行.exe文件</a><li><a href="/story/7888.html">如何删除可怕的BoBrowser广告软件/恶意软件</a><li><a href="/story/7521.html">如何在Windows中查看最近打开的文件列表</a><li><a href="/story/7421.html">如何在Ubuntu 14.04中轻松添加和删除程序</a><li><a href="/story/7219.html">如何将Windows程序重置为其默认设置</a><li><a href="/story/6981.html">如何在Ubuntu 14.04中管理启动应用程序</a><li><a href="/story/6934.html">Windows之前的PC：使用MS-DOS实际上是什么样子</a><li><a href="/story/6888.html">如何查看您在Ubuntu 14.10中还剩下多少磁盘空间</a><li><a href="/story/6536.html">如何在Windows中禁用启动程序</a><li><a href="/story/6496.html">如何使用Uncheckky避免垃圾软件优惠</a></ul></div></div><div id="footer">&copy 2020 fuzadu.com</div></body></html>