<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用rsync同步数据的非初学者指南</title><link rel="stylesheet" href="/css.css"></head><body><div id="header"><a class="site_title" href="http://www.fuzadu.com">复杂度</a></div><div><div><h2>使用rsync同步数据的非初学者指南</h2></div><div class="content"><img class="content_img" src="/image/57/57d06df6ad31e7a537df4e1a28ca2a48.jpg" /><p>rsync协议可以非常简单地用于普通备份/同步作业，但是它的一些更高级的功能可能会让您大吃一惊。在本文中，我们将展示即使是最大的数据囤积者和备份爱好者也可以使用rsync作为单一解决方案来满足其所有数据冗余需求。</p><p>警告：仅限高级极客</p><p>如果你坐在那里想“rsync到底是什么？”或者“我只将rsync用于非常简单的任务”，您可能想看看我们以前关于如何使用rsync在Linux上备份数据的文章，其中介绍了rsync，指导您完成安装，并展示了它更基本的功能。一旦您牢牢掌握了如何使用rsync(老实说，它并没有那么复杂)，并且熟悉了Linux终端，您就可以开始阅读这本高级指南了。</p><p>在Windows上运行rsync</p><p>首先，让我们让我们的Windows读者与我们的Linux专家站在同一个页面上。虽然rsync是为在类Unix系统上运行而构建的，但你没有理由不能在Windows上同样轻松地使用它。*Cygwin产生了一个很棒的Linux API，我们可以用它来运行rsync，所以请前往他们的网站下载32位或64位版本，具体取决于您的计算机。</p><p>安装很简单；在进入“Select Packages”屏幕之前，您可以保持所有选项的默认值。</p><img class="content_img" src="/image/31/317b397c79c4c90479677314a013cbb6.jpg" /><p>现在，您需要对Vim和SSH执行相同的步骤，但是当您选择这些包时，它们的外观会略有不同，因此下面是一些屏幕截图：</p><p>安装Vim：</p><img class="content_img" src="/image/69/69a9d847e24a1cd30b45242214cf23e8.jpg" /><p>安装SSH：</p><img class="content_img" src="/image/d0/d076cf69eb5a4e9e2d552d14b2232e22.jpg" /><p>选择这三个软件包后，继续单击Next，直到完成安装。然后你可以通过点击安装程序放在你桌面上的图标来打开Cygwin。</p><p>rsync命令：从简单到高级</p><p>既然Windows用户意见一致，让我们来看一个简单的rsync命令，并展示一些高级开关的使用如何很快使问题变得复杂。</p><p>假设您有一堆需要备份的文件-现在谁不需要呢？当您插入便携式硬盘以便备份计算机文件时，并发出以下命令：</p><p>或者，它在装有Cygwin的Windows计算机上的外观：</p><p>非常简单，在这一点上真的不需要使用rsync，因为你可以只拖放文件。但是，如果你的另一个硬盘已经有一些文件，只需要更新的版本加上自上次同步以来创建的文件，这个命令很方便，因为它只会将新数据发送到硬盘上。对于大文件，特别是通过互联网传输文件，这是一个很大的问题。</p><p>将文件备份到外部硬盘驱动器，然后将硬盘驱动器放在与计算机相同的位置，这是一个非常糟糕的主意，所以让我们来看看开始通过互联网将文件发送到另一台计算机(您租用的计算机，家人的计算机，等等)需要做些什么。</p><p>上面的命令会将您的文件发送到IP地址为10.1.1.1的另一台计算机上。它会从目标中删除源目录中不再存在的无关文件，输出正在传输的文件名，以便您知道发生了什么，并在端口12345上通过ssh隧道rsync。</p><p>-a-v-e--delete开关是一些最基本、最常用的开关；如果您正在阅读本教程，您应该已经对它们有了很好的了解。让我们来看看其他一些有时会被忽略但非常有用的开关：</p><p>--进度-此开关允许我们查看每个文件的传输进度。当通过Internet传输大文件时，它特别有用，但当仅通过快速网络传输小文件时，它可以输出大量无意义的信息。</p><p>使用--Progress开关作为备份的rsync命令正在进行：</p><img class="content_img" src="/image/fc/fc5348535ebff86a256ff4e92082eeba.jpg" /><p>--PARTIAL-这是在通过Internet传输大文件时特别有用的另一个开关。*如果rsync在文件传输过程中因任何原因中断，则部分传输的文件将保留在目标目录中，一旦再次执行rsync命令，传输将从停止的位置恢复。当通过Internet传输大文件(例如，几GB)时，没有什么比几秒钟的互联网中断、蓝屏或人为错误导致文件传输中断并不得不重新开始更糟糕的了。</p><p>-p-此开关结合了--Progress和--Partial，因此改为使用它，它会使您的rsync命令更整洁一些。</p><p>-z或--compress-此开关将使rsync在传输文件数据时对其进行压缩，从而减少必须发送到目标的数据量。它实际上是一个相当常见的开关，但远不是必需的，只有在慢速连接之间的传输中才能真正为您带来好处，并且它对以下类型的文件不起任何作用：7z、avi、bz2、deb、g、z iso、jpeg、jpg、mov、mp3、mp4、ogg、rpm、tbz：7z、avi、bz2、deb、g、z iso、jpeg、jpg、mov、mp3、mp4、ogg、rpm、tbz</p><p>-h或--人类可读的--如果您正在使用--Progress开关，您肯定也会想要使用这个参数。也就是说，除非您想要动态地将字节转换为MB。-h开关将所有输出的数字转换为人类可读的格式，因此您实际上可以理解正在传输的数据量。</p><p>-n或--预演-此开关对于了解您第一次编写rsync脚本并测试它的时间非常重要。如果它执行试运行，但实际上不做任何更改-可能的更改仍会正常输出，因此在将脚本投入生产之前，您可以仔细阅读所有内容并确保它看起来没有问题。(=</p><p>-R或--Relative--如果目标目录尚不存在，则必须使用此开关。*我们将在本指南的后面部分使用此选项，以便可以在目标计算机上创建文件夹名称中带有时间戳的目录。</p><p>--EXCLUDE-FROM-此开关用于链接到包含不希望备份的目录路径的排除列表。*它只需要每行都有目录或文件路径的纯文本文件。</p><p>--INCLUDE-FROM-类似于--EXCLUDE-FROM，但它链接到包含要备份的数据的目录和文件路径的文件。</p><p>--stats-无论如何都不是一个真正重要的开关，但如果您是一名系统管理员，了解每个备份的详细统计信息会很方便，这样您就可以监控通过网络发送的通信量等等。</p><p>--log-file-允许您将rsync输出发送到日志文件。我们绝对推荐在自动备份时使用这一功能，因为在自动备份中，您不需要亲自阅读输出。我们总是在空闲时间给日志文件检查一遍，以确保一切正常工作。此外，这也是系统管理员使用的一个关键开关，这样您就不会在让实习生负责的情况下感到疑惑备份是如何失败的。</p><p>现在我们再来看一下rsync命令，因为我们又添加了几个开关：</p><p>命令仍然非常简单，但我们仍然没有创建一个像样的备份解决方案。“即使我们的文件现在位于两个不同的物理位置，此备份也无法保护我们免受数据丢失的主要原因之一：人为错误的影响。</p><p>快照备份</p><p>如果您意外删除了文件，病毒损坏了您的任何文件，或者发生了其他事情，导致您的文件被意外更改，然后您运行rsync备份脚本，您的备份数据将被不需要的更改覆盖。当发生这种情况时(不是如果，而是何时)，您的备份解决方案对您的数据丢失没有任何保护作用。</p><p>rsync的创建者意识到了这一点，并添加了--backup和--backup-dir参数，以便用户可以运行差异备份。rsync网站上的第一个示例显示了一个脚本，其中每七天运行一次完整备份，然后每天在单独的目录中备份对这些文件的更改。这种方法的问题是，要恢复文件，您必须有效地恢复它们七次。此外，大多数极客每天都会运行几次备份，因此您可以很容易地在以下位置拥有20多个不同的备份目录。但是，即使只是查看备份的数据也可能非常耗时-您必须知道文件最后一次更改的时间，才能找到其最新的备份副本。最重要的是，仅每周(在某些情况下甚至更少)运行增量备份的效率很低。</p><p>快照备份来拯救！快照备份只不过是增量备份，但它们利用硬链接来保留原始源的文件结构。这可能一开始很难理解，所以让我们来看一个例子。</p><p>假设我们有一个备份脚本正在运行，该脚本每两小时自动备份一次我们的数据。每当rsync执行此操作时，它都会以以下格式命名每个备份：backup-月-日-年-时间。</p><p>因此，在典型的一天结束时，我们在目标目录中会有一个文件夹列表，如下所示：</p><img class="content_img" src="/image/2a/2a6a149d98104f3f307e45e8c0ac461f.jpg" /><p>当遍历这些目录中的任何一个时，您会看到源目录中的每个文件都与当时完全相同。但是，在任何两个目录中都不会有重复的文件。Rrsync通过使用--link-dest=DIR参数使用硬链接来实现这一点。</p><p>当然，为了拥有这些日期整齐的目录名称，我们将不得不稍微增强我们的rsync脚本。让我们看一下实现这样的备份解决方案需要做些什么，然后我们将更详细地解释该脚本：</p><p>这将是一个典型的快照rsync脚本。如果我们在什么地方失去了您，让我们逐个分析一下：</p><p>我们脚本的第一行将time.txt的内容复制到time2.txt中，yes管道是为了确认我们要覆盖该文件，接下来我们取当前时间放到time.txt中，以后这些文件就派上用场了。</p><p>下一行生成rsync日志文件，将其命名为rsync-date.log(其中date是实际的日期和时间)。</p><p>现在，我们一直警告您的复杂rsync命令：</p><p>-avzhPR、-e、--delete、--stats、--log-file、--exclude-from、--link-est-只是我们前面谈到的开关；如果需要刷新，请向上滚动。</p><p>--chmod=du=rwx，dgo=rx，fu=rw，fgo=r-这些是目标目录的权限。*由于我们在rsync脚本中间创建此目录，因此需要指定权限，以便我们的用户可以向其中写入文件。</p><p>DATE和CAT命令的使用</p><p>我们将按照rsync命令中DATE和CAT命令的出现顺序逐一介绍它们的每次使用。1注意：我们知道还有其他方法可以实现此功能，特别是通过使用声明变量，但出于本指南的目的，我们决定使用此方法。</p><p>日志文件指定为：</p><p>或者，我们可以将其指定为：</p><p>无论采用哪种方式，--log-file命令都应该能够找到以前创建的日期为的日志文件并将其写入。</p><p>链接目标文件指定为：</p><p>这意味着将为--link-est命令提供上一次备份的目录。如果我们每两小时运行一次备份，并且在运行此脚本时是下午4：00，那么--link-est命令将查找在下午2：00创建的目录，并且只传输此后更改过的数据(如果有)。</p><p>再次重申，这就是为什么在脚本开头将time.txt复制到time2.txt，以便--link-est命令稍后可以引用该时间。</p><p>目标目录指定为：</p><p>此命令只是将源文件放入一个标题为当前日期和时间的目录中。</p><p>最后，我们确保在备份中放置了日志文件的副本。</p><p>我们在端口12345上使用Secure Copy来获取rsync日志并将其放在正确的目录中。要选择正确的日志文件并确保它最终位于正确的位置，必须通过cat命令引用time.txt文件。如果您想知道为什么我们决定cat time.txt而不是只使用date命令，这是因为rsync命令运行时可能已经经历了很长时间，因此为了确保我们有正确的时间，我们只对我们之前创建的文本文档进行cat。</p><p>自动化 / 自动操作</p><p>在Linux上使用Cron或在Windows上使用Task Scheduler自动执行rsync脚本。您必须注意的一件事是，在继续新的rsync进程之前，请确保结束所有当前正在运行的rsync进程。Task Scheduler似乎会自动关闭所有已在运行的实例，但对于Linux，您需要更有创造性。</p><p>大多数Linux发行版都可以使用pkill命令，因此只需确保在rsync脚本的开头添加以下内容：</p><p>编码</p><p>不，我们还没有完成。我们终于有了一个奇妙的(而且免费的！)。备份解决方案已经到位，但我们所有的文件仍然容易被盗。希望您将文件备份到数百英里外的某个地方。“无论那个遥远的地方有多安全，盗窃和黑客攻击总是会成为问题。”</p><p>在我们的示例中，我们所有的rsync流量都通过SSH隧道传输，这意味着我们所有的文件在传输到其目的地时都是加密的。*但是，我们需要确保目的地同样安全。*请记住，rsync只在数据传输时加密数据，但文件到达目的地后是完全开放的。</p><p>rsync最好的功能之一是，它只传输每个文件中的更改。如果您对所有文件进行了加密，并进行了一个微小更改，则在任何更改后，由于加密会完全随机化所有数据，因此必须重新传输整个文件。</p><p>因此，最好/最简单地使用某种类型的磁盘加密，例如Windows的BitLocker或Linux的dm-crypt。这样，您的数据在被盗的情况下会受到保护，但文件可以使用rsync传输，您的加密不会影响其性能。还有其他可用的选项，它们的工作原理类似于rsync，甚至实现某种形式的rsync，例如双重性，但它们缺少rsync必须提供的一些功能。</p><p>在异地位置设置快照备份并加密源和目标硬盘驱动器后，请为掌握rsync和实施尽可能最安全的数据备份解决方案而鼓掌。</p><div class="item_info"><span class="item_key"><a href="/tag/文件/">文件</a></span><span class="item_key"><a href="/tag/rsync/">rsync</a></span><span class="item_key"><a href="/tag/备份/">备份</a></span></div></div><div class="relate_story"><div><h3>相关文章</h3></div><ul><li><a href="/story/14796.html">如何在Linux上使用JOIN命令</a><li><a href="/story/14712.html">如何使用Google Drive Progative Web App</a><li><a href="/story/14624.html">解释的Linux文件时间戳：atime、mtime和ctime</a><li><a href="/story/14550.html">如何在Linux上使用Tail命令</a><li><a href="/story/14514.html">您想知道的关于Linux上的inode的所有信息</a><li><a href="/story/14471.html">如何在Google Drive中更改文件所有者</a><li><a href="/story/14454.html">如何在Linux上使用stat命令</a><li><a href="/story/14419.html">如何在Linux中获取文件或目录的大小</a><li><a href="/story/14347.html">如何使用cURL从Linux命令行下载文件</a><li><a href="/story/14315.html">免费下载：Microsoft批量重命名PowerToy</a><li><a href="/story/14306.html">如何创建USB驱动器的映像</a><li><a href="/story/14240.html">如何在Linux上使用LESS命令</a><li><a href="/story/14209.html">如何在Google Drive中分配任务</a><li><a href="/story/14188.html">如何最终确定和撤销对共享Google文件的访问</a><li><a href="/story/14167.html">如何共享指向您的Google文件的“复制”链接</a><li><a href="/story/14164.html">如何将Google文档、工作表或幻灯片文件共享为网页</a><li><a href="/story/14127.html">如何在iPhone和iPad上将文件复制和备份到外部存储</a><li><a href="/story/14088.html">如何在iPhone或iPad上使用Safari下载文件</a><li><a href="/story/14037.html">如何在Linux上创建别名和Shell函数</a><li><a href="/story/14026.html">如何在Linux上使用chgrp命令</a></ul></div></div><div id="footer">&copy 2020 fuzadu.com</div></body></html>