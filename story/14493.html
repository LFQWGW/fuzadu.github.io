<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何在Linux上创建交换文件</title><link rel="stylesheet" href="/css.css"></head><body><div id="header"><a class="site_title" href="http://www.fuzadu.com">复杂度</a></div><div><div><h2>如何在Linux上创建交换文件</h2></div><div class="content"><p>向Linux计算机添加交换空间，或增加已有的交换空间，而不会扰乱分区。我们将向您展示定制交换空间的简单方法。</p><p>交换文件与交换分区</p><p>在几种情况下，您可能需要增加Linux计算机的现有交换空间或添加新的交换空间。</p><p>
可能您的交换空间经常以最大值或接近最大值运行。
在安装过程中很容易单击错误的选项，并且很容易无意中拒绝向系统添加交换空间。
也许您之前决定您有太多的随机存取存储器(RAM)，不需要任何交换，并且您已经改变了主意。
有时，您会继承没有交换的系统的管理，原因是您永远无法发现。</p><p>所有这些问题的简单解决方案是将交换文件添加到您的计算机。这是一个特殊文件，预先分配并保留用作交换空间。交换文件将与您可能拥有的任何现有交换协同工作，无论是交换文件还是交换分区。</p><p>一度，与使用交换分区相比，使用交换文件会影响性能。随着机械(旋转)硬盘驱动器性能的提高和Linux操作系统内交换功能效率的提高，情况不再是这样了。事实上，一些Linux发行版现在默认创建交换文件，而不是交换分区。</p><p>当内存不足时，交换不仅仅是一种释放RAM的方法。这是一个运转良好的系统的重要组成部分。如果没有任何交换，内核将很难实现正常的内存管理。让我们看看添加一些交换空间的简单方法。</p><p>在我们开始之前：Btrf和SSD</p><p>有两点我们想快速讨论一下。</p><p>Btrfs文件系统对交换文件有某些警告。Btrfs想要以一种方式操作，而交换文件需要以另一种方式操作，这两者之间一度存在冲突，一些交换文件所依赖的功能没有实现，一些关于交换文件内的块编号的假设在Btrfs中并不成立，所以交换文件不被支持。</p><p>从内核5.0开始，您可以在Btrfs文件系统中拥有交换文件，前提是它们设置为满足以下要求：</p><p>
没有写入时复制(NOCOW)文件。
它们没有被压缩。
它们不会跨越不同的硬盘驱动器。</p><p>大多数读者将使用默认的ext4文件系统，因此这对他们来说不是问题。</p><p>相关：您应该使用哪种Linux文件系统？</p><p>当固态驱动器(SSD)首次出现时，人们担心在文件系统写入频繁的情况下使用它们。人们被警告不要将交换空间放在SSD上，甚至要避免将系统记录到SSD。</p><p>如今，这已经不是什么问题了，而且许多正在销售的固态硬盘的预期寿命都会比大多数PC都要长。SSD上的交换文件比机械硬盘上的交换分区具有更好的性能。</p><p>相关：固态硬盘到底能持续多久？</p><p>正在检查现有交换空间</p><p>三思而后行。让我们检查一下您的计算机上有哪些交换空间可用。您可以用两种方法来完成这项工作，我们将同时使用这两种方法。free命令将显示已用内存和空闲内存。h(人类可读)选项将导致在显示内存值时自由使用敏感单位。</p><code>free -h</code><img class="content_img" src="/image/ce/ce30753fa1c524b5bf71dffe0f295abf.png" /><p>free的输出显示该计算机上没有配置交换空间。</p><p>在没有出现RAM和空闲RAM的情况下，从不讨论交换。因此，值得注意的是，空闲RAM是以237MB的形式给出的。不要将其误认为可用内存总量。该值由“可用”数字提供，即881MB。</p><p>Linux将空闲RAM用于自己的目的，如文件缓存和内核缓冲区。专用于此的RAM大小是“缓冲区/缓存”数字，为871MB。但这段记忆仍然被认为是“可用的”，并被计算为“可用”。“buf/cache”RAM的内容可以立即丢弃，并由需要一些内存的任何应用程序使用。</p><p>检查交换空间是否可用的另一种方法是使用swapon命令。show选项不会对您计算机上的交换进行任何更改。它只提供统计数据。</p><code>swapon --show</code><img class="content_img" src="/image/b5/b5d32b7e87668a2d4cd0738d737af840.png" /><p>如果此命令没有输出，则没有配置交换。</p><p>如果这些命令显示已经配置了一些交换空间，那么现有交换空间的大小应该考虑到要创建的交换文件的大小。</p><p>我需要多少交换空间？</p><p>传统的回答是“两倍于你拥有的内存量”。但这是在计算机内存非常有限的时候创造出来的。随着RAM变得更便宜，程序和游戏对内存的要求越来越高，PC的规格也相应地进行了调整。如今，拥有32 GB内存的家用PC并不少见。如果您有32 GB的RAM，则不会分配64 GB的硬盘空间来交换空间。这显然太过分了。</p><p>你需要的互换数量是一个煽动性的话题，可以与“哪个是最好的编辑”相提并论。我们在Ubuntu交换常见问题中看到的关于这个话题的最明智的讨论之一。这是一种简短的常识性方法(尽管，像许多人一样，他们误解了swappy在Linux上的工作原理)。有一个方便的表格，其中显示了针对系统拥有的RAM以及是否将计算机休眠所需的推荐交换空间量。</p><p>好消息是，你选择什么价值并不重要。我们可以随时删除交换文件，并将其替换为更大的交换文件或更小的交换文件。或者，您可以只添加另一个交换文件。</p><p>从表中选择交换文件大小，并运行一段时间。监视系统对交换空间的使用情况。如果需要微调，则很容易进行更改。使用交换文件，这是两分钟的工作。将其与在活动的Linux计算机上调整分区进行比较。</p><p>相关：什么是Linux上的Swappness？(以及如何改变它)</p><p>创建交换文件</p><p>您不应该使用falocate命令来创建交换文件。这来自Swapon的手册页：</p><code>The swap file implementation in the kernel expects to be able to write to
the file directly, without the assistance of the file system. 

This is a problem on files with holes or on copy-on-write files on file 
systems like Btrfs. Commands like cp(1) or truncate(1) create files with 
holes. These files will be rejected by swapon. 

Preallocated files created by fallocate(1) may be interpreted as files 
with holes too depending of the filesystem. Preallocated swap files are 
supported on XFS since Linux 4.18. 

The most portable solution to create a swap file is to use dd(1) and 
/dev/zero.</code><p>因此，虽然falocate速度更快，但我们将使用dd创建交换文件。用于研究本文的机器有2 GB的RAM。我们将创建一个1 GB的交换文件。</p><p>备选办法是：</p><p>
if：输入文件。在本例中，我们使用/dev/zero，它将提供零字节流。
OF：输出文件。我们将在根目录中创建一个名为swapfile的文件。
BS：以字节为单位的块大小。这指定一次从输入文件读取和写入输出文件的字节数。
计数：要读写的块数。将此数字乘以bs值，即可得到文件大小。</p><code>sudo dd if=/dev/zero of=/swapfile bs=1024 count=1048576</code><img class="content_img" src="/image/3b/3b97a736f41920e88d6d7f0d49434fdf.png" /><p>创建文件时会提供一些统计信息。</p><img class="content_img" src="/image/54/5420ecd27ef1a3510f90c19d629863b0.png" /><p>我们可以看到写入文件的块(记录)数量、文件大小、创建文件所用的时间和有效数据传输率。</p><p>使用ls命令查看根目录中的文件：</p><code>ls /</code><img class="content_img" src="/image/ee/eee86439290c3d3e66a6afdbb14b824e.png" /><p>准备交换文件</p><p>在使用交换文件之前，我们需要使用mkexchange命令准备交换文件。除了文件的路径和名称外，我们不需要为mkexchange提供任何参数：</p><code>sudo mkswap /swapfile</code><img class="content_img" src="/image/4f/4f6e889b9bd48a03321d5b5c3d41f9ce.png" /><p>该文件已准备好用作交换文件。请注意有关文件权限的警告。我们需要更改这些设置，以便root用户是唯一可以读写交换文件的用户。</p><p>使用交换文件</p><p>默认权限太自由了，我们需要限制它们，以便只有超级用户才能使用交换文件。使用chmod更改文件权限：</p><code>sudo chmod 600 /swapfile</code><img class="content_img" src="/image/ad/ad600a828d42ee8a9f4d4f68c788e5de.png" /><p>这将删除文件组成员和其他成员的所有权限，但允许文件所有者root读取和写入文件。</p><p>相关：如何在Linux上使用chmod命令</p><p>我们需要使用*swapon命令让Linux知道有一个新的交换文件可供使用。我们只需要提供路径和文件名：</p><code>sudo swapon /swapfile</code><img class="content_img" src="/image/37/3705baf020ab2925221b6ca038b864fb.png" /><p>交换文件现在处于活动状态。</p><p>将交换文件添加到fstab</p><p>要确保您的交换文件在重新引导后可用，请将其添加到/etc/fstab文件。您可以使用您喜欢的任何文本编辑器，但我们将使用图形Gedit文本编辑器演示该过程。</p><code>sudo gedit /etc/fstab</code><img class="content_img" src="/image/c4/c4401272cff52e157106f0d7faa2f8ea.png" /><p>我们需要添加到文件底部的行是：</p><code>/swapfile    none    swap    sw    0    0</code><img class="content_img" src="/image/9b/9bbd43f89705451138ccb93fd2c2661b.png" /><p>这些字段包括：</p><p>
文件系统：交换文件的路径和名称。
挂载点：该文件不像文件系统那样挂载，因此条目为“None”。
类型：这是“交换”。
选项：在引导时，将从一个引导脚本调用swapon-a命令(启动所有标记为交换的设备)。该选项告诉Linux将此条目视为应由swapon-a命令控制的交换资源。这里使用“DEFAULTS”是很常见的，因为一些Linux用户错误地认为这个字段被忽略了。正如我们将看到的，情况并非如此。因此，使用正确的选项是有意义的。
转储：可以设置为零。在这种情况下这是无关紧要的。
通过：此参数可以设置为零。在这种情况下这是无关紧要的。</p><p>保存更改并关闭编辑器。</p><p>相关：如何在Linux上编写fstab文件</p><p>检查交换使用情况</p><p>要查看您的交换空间是否正在使用，请使用带有--show选项的swapon命令：</p><code>swapon --show</code><img class="content_img" src="/image/e1/e147845050724b4858f73723654c0d83.png" /><p>这些列包括：</p><p>
名称：交换分区或交换文件的名称。
类型：交换设备的类型。
Size：交换资源的大小。
已用：已用交换空间量。
PRIO：此交换空间的优先级。</p><p>交换空间优先级</p><p>每个交换空间都分配有优先级。如果您不提供，则会自动分配一个。自动分配的优先级始终为负值。可以手动分配的优先级范围为0到32767。优先使用优先级较高的交换资源。</p><p>如果多个交换空间具有相同的优先级，则会交替使用它们，直到它们都已满为止，然后系统会查找下一个优先级最低的交换空间。*如果您只有一个交换空间，那么优先级当然无关紧要。但我们将更改我们创建的交换文件的优先级，以演示如何执行此操作。</p><p>要设置优先级，请在/etc/fstab条目中添加*pri=1(优先级)选项。编辑您添加到/etc/fstab命令的行，如下所示：</p><code>/swapfile    none    swap    sw,pri=10    0    0</code><p>也就是说，将pri=10添加到Options字段，并用逗号与“SW”隔开。不要在“sw”、逗号和“pri=10”之间留任何空格。重新启动计算机并使用swapon--show命令：</p><code>swapon -- show</code><img class="content_img" src="/image/4a/4ac77399e8cf3fe64e322f600f841963.png" /><p>此交换空间的优先级已提升到10。这证明/etc/fstab条目中的选项字段没有被忽略。</p><p>轻松交换空间</p><p>通过阐述和解释，我们可以像这样轻松、快速地创建一个新的交换文件：</p><code>sudo dd if=/dev/zero /of=/swapfile2 bs=1024 count=104857</code><code>sudo mkswap /swapfile2</code><code>sudo chmod 600 /swapfile2</code><code>sudo swapon /swapfile2</code><p>让我们检查一下它是否起作用了：</p><code>swapon --show</code><img class="content_img" src="/image/3e/3e570e12218b5de7ec44a278c9c66a87.png" /><p>如果希望永久删除，请将其放入/etc/fstab文件中。</p><p>砰。任务完成了。</p><div class="item_info"><span class="item_key"><a href="/tag/交换/">交换</a></span><span class="item_key"><a href="/tag/交换文件/">交换文件</a></span><span class="item_key"><a href="/tag/使用/">使用</a></span></div></div><div class="relate_story"><div><h3>相关文章</h3></div><ul><li><a href="/story/14405.html">什么是Linux上的Swappness？(以及如何改变它)</a></ul></div></div><div id="footer">&copy 2020 fuzadu.com</div></body></html>